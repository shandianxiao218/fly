# 北斗导航卫星可见性分析系统 - C语言TDD开发需求

## 1. 系统概述

基于C语言开发的专业北斗导航卫星可见性分析系统，采用TDD（测试驱动开发）方法构建。系统通过subagent架构实现模块化设计，提供高性能的卫星可见性分析和实时可视化功能。

## 2. 技术架构

### 2.1 开发方法
- **编程语言**: C语言 (C11/C17标准)
- **测试框架**: CuTest
- **开发方法**: TDD（测试驱动开发）
- **版本控制**: Git
- **构建系统**: Make
- **平台**: Windows 10/11

### 2.2 Agent架构设计
- **backend-architect**: 设计C语言后端架构和API接口
- **c-pro**: 负责C语言核心算法和数据结构实现
- **debugger**: 调试和测试验证，性能分析
- **ai-engineer**: 集成C语言后端和Web前端
- **frontend-developer**: Chart.js可视化和Web界面开发
- **code-reviewer**: 代码质量审查和优化建议

### 2.3 系统架构
```
C语言后端 ←→ HTTP服务器 ←→ Chart.js前端
```

## 3. 核心功能需求

### 3.1 真实卫星数据支持

#### 3.1.1 RINEX星历数据解析
- **数据格式**: RINEX 3.0格式
- **支持内容**: 北斗卫星轨道参数和时钟参数
- **解析精度**: 毫秒级时间精度
- **坐标系统**: WGS84坐标系
- **Agent分工**: c-pro负责核心解析，backend-architect设计接口

#### 3.1.2 卫星位置计算
- **计算方法**: 基于星历数据的精确轨道计算
- **考虑因素**: 地球自转、相对论效应
- **性能要求**: < 10ms per satellite
- **测试要求**: CuTest单元测试覆盖 > 90%

### 3.2 飞行轨迹仿真

#### 3.2.1 自动轨迹生成
- **生成方式**: 系统自动模拟产生飞行轨迹
- **更新频率**: 每秒更新一次位置和姿态数据
- **轨迹类型**:
  - 标准起飞降落轨迹
  - 巡航飞行轨迹
  - 机动飞行轨迹
  - 极端姿态轨迹

#### 3.2.2 姿态数据模拟
- **姿态参数**: 俯仰角、横滚角、偏航角
- **数据范围**:
  - 俯仰角: -30° 到 +30°
  - 横滚角: -45° 到 +45°
  - 偏航角: 0° 到 360°
- **变化率**: 符合实际飞机动力学特性

#### 3.2.3 CSV轨迹文件支持
- **文件格式**: CSV格式
- **导入方式**: 文件上传或文本输入
- **数据验证**: 格式和数值范围验证
- **错误处理**: 详细的错误提示和修正建议

### 3.3 天线遮挡模型

#### 3.3.1 天线位置
- **安装位置**: 飞机下方50cm处
- **安装方式**: 机身底部中心位置
- **天线类型**: 全向天线（默认）

#### 3.3.2 遮挡模型
- **遮挡源**:
  - 机身遮挡
  - 机翼遮挡
  - 尾翼遮挡
- **遮挡特性**:
  - 遮挡面积不确定（动态变化）
  - 遮挡角度根据飞机姿态实时计算
  - 考虑遮挡物的几何形状和材质

#### 3.3.3 遮挡计算算法
- **计算方法**: 基于3D几何模型的射线追踪
- **精度要求**: 角度精度±1°
- **实时性**: 每秒更新遮挡状态
- **性能要求**: < 100ms per time step

### 3.4 Web可视化

#### 3.4.1 Chart.js集成
- **显示内容**: 卫星可见性数量变化、信号强度变化
- **更新频率**: 1Hz实时更新
- **交互功能**: 时间轴控制、参数调整
- **Agent分工**: frontend-developer负责界面开发

#### 3.4.2 HTTP服务器
- **协议**: HTTP/1.1
- **数据格式**: JSON
- **端口**: 8080（默认）
- **API设计**: RESTful风格
- **Agent分工**: ai-engineer负责集成

## 4. 技术规格

### 4.1 数据格式要求

#### 4.1.1 RINEX星历数据格式
使用RINEX 3.0格式标准，包含北斗卫星的轨道参数和时钟参数。

#### 4.1.2 CSV轨迹文件格式
```csv
timestamp,latitude,longitude,altitude,pitch,roll,yaw,velocity
2024-01-01T00:00:00Z,39.9042,116.4074,10000,0.0,0.0,0.0,250.0
2024-01-01T00:00:01Z,39.9045,116.4078,10000,0.5,0.2,0.1,250.5
```

字段说明：
- **timestamp**: ISO 8601格式时间戳
- **latitude**: 纬度（度），范围：-90到90
- **longitude**: 经度（度），范围：-180到180
- **altitude**: 高度（米），范围：0到20000
- **pitch**: 俯仰角（度），范围：-30到30
- **roll**: 横滚角（度），范围：-45到45
- **yaw**: 偏航角（度），范围：0到360
- **velocity**: 速度（米/秒），范围：0到500

### 4.2 性能要求

#### 4.2.1 计算性能
- **卫星位置计算**: < 10ms per satellite
- **可见性分析**: < 50ms per time step
- **遮挡计算**: < 100ms per time step
- **数据更新频率**: 1Hz（每秒更新）

#### 4.2.2 系统性能
- **内存使用**: < 1GB
- **CPU使用率**: < 50%
- **响应时间**: < 100ms
- **并发处理**: 支持10个并发连接

### 4.3 开发规范

#### 4.3.1 C语言规范
- 使用C11/C17标准
- 遵循MISRA C安全编码规范
- 内存管理：避免内存泄漏，使用valgrind检查
- 错误处理：完善的错误处理机制

#### 4.3.2 TDD规范
- 测试先行：先写测试，再写实现
- 测试覆盖率：单元测试覆盖率 > 90%
- 红绿重构：Red-Green-Refactor循环
- 持续集成：每次提交都运行测试

#### 4.3.3 Git提交规范
- 提交格式：`类型(模块): 简短描述`
- 提交类型：feat, fix, test, docs, style, refactor, chore
- 示例：`feat(satellite): 添加RINEX解析功能`
- 每个功能点完成后立即提交

## 5. 项目结构

### 5.1 目录结构
```
beidou-analysis/
├── src/                    # 源代码
│   ├── satellite/         # 卫星相关模块
│   │   ├── rinex.c/.h     # RINEX解析
│   │   ├── orbit.c/.h     # 轨道计算
│   │   └── position.c/.h   # 位置计算
│   ├── aircraft/          # 飞机相关模块
│   │   ├── trajectory.c/.h # 轨迹生成
│   │   ├── attitude.c/.h  # 姿态计算
│   │   └── csv_parser.c/.h # CSV解析
│   ├── obstruction/       # 遮挡计算模块
│   │   ├── geometry.c/.h  # 几何计算
│   │   ├── obstruction.c/.h # 遮挡算法
│   │   └── aircraft_model.c/.h # 飞机模型
│   ├── web/              # Web服务器模块
│   │   ├── http_server.c/.h # HTTP服务器
│   │   ├── api.c/.h      # API接口
│   │   └── json_utils.c/.h # JSON工具
│   └── utils/            # 工具函数
│       ├── math_utils.c/.h # 数学工具
│       ├── time_utils.c/.h # 时间工具
│       └── logger.c/.h   # 日志工具
├── tests/                 # 测试代码
│   ├── unit/             # 单元测试
│   │   ├── test_satellite.c
│   │   ├── test_aircraft.c
│   │   ├── test_obstruction.c
│   │   └── test_utils.c
│   └── integration/      # 集成测试
│       ├── test_api.c
│       └── test_workflow.c
├── web/                  # Web前端
│   ├── static/          # 静态文件
│   │   ├── css/
│   │   ├── js/
│   │   └── lib/
│   └── templates/       # HTML模板
│       └── index.html
├── data/                 # 数据文件
│   ├── rinex/           # RINEX示例
│   └── trajectories/    # 轨迹示例
├── lib/                  # 第三方库
│   ├── cutest/          # CuTest框架
│   ├── jansson/         # JSON库
│   └── libcurl/         # HTTP库
├── build/               # 构建输出
├── docs/                # 文档
├── Makefile            # 构建脚本
└── README.md            # 说明文档
```

### 5.2 构建系统
```makefile
# Makefile示例
CC = gcc
CFLAGS = -std=c11 -Wall -Wextra -O2
INCLUDES = -I./lib/cutest -I./lib/jansson/src -I./lib/curl/include
LIBS = -L./lib/jansson/src/.libs -L./lib/curl/lib -ljansson -lcurl -lm

# 目标
all: build test

build: beidou-server

test: test_runner
	./test_runner

beidou-server: $(SRC_FILES)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $^ $(LIBS)

test_runner: $(TEST_FILES)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $^ $(LIBS) -L./lib/cutest -lcutest
```

## 6. 开发流程

### 6.1 TDD开发流程

#### 6.1.1 第一步：编写失败的测试
```c
// test_satellite.c
void test_rinex_parsing(void) {
    RinexData* data = parse_rinex_file("test.rnx");
    CU_ASSERT_PTR_NOT_NULL(data);
    CU_ASSERT_EQUAL(data->satellite_count, 35);
    // 更多断言...
}
```

#### 6.1.2 第二步：实现最小代码
```c
// rinex.c
RinexData* parse_rinex_file(const char* filename) {
    // 最小实现
    return NULL; // 测试会失败
}
```

#### 6.1.3 第三步：使测试通过
```c
// rinex.c
RinexData* parse_rinex_file(const char* filename) {
    RinexData* data = malloc(sizeof(RinexData));
    data->satellite_count = 35;
    return data; // 测试通过
}
```

#### 6.1.4 第四步：重构优化
```c
// 重构：添加错误处理、内存管理等
```

### 6.2 Git工作流

#### 6.2.1 功能开发
```bash
# 创建功能分支
git checkout -b feature/satellite-parsing

# 编写测试（红色）
git add tests/unit/test_satellite.c
git commit -m "test(satellite): 添加RINEX解析测试"

# 实现功能（绿色）
git add src/satellite/rinex.c
git commit -m "feat(satellite): 实现RINEX解析功能"

# 重构优化
git add src/satellite/rinex.c
git commit -m "refactor(satellite): 优化RINEX解析性能"

# 合并到主分支
git checkout main
git merge feature/satellite-parsing
```

#### 6.2.2 代码审查
- 使用code-reviewer agent进行代码审查
- 检查代码质量、性能、安全性
- 确保符合开发规范

## 7. Agent分工协作

### 7.1 backend-architect
- 设计系统架构和API接口
- 定义数据结构和模块划分
- 制定开发规范和标准

### 7.2 c-pro
- 实现C语言核心算法
- 编写高效的数据结构
- 优化性能和内存管理

### 7.3 debugger
- 编写和执行测试用例
- 调试和修复问题
- 性能分析和优化

### 7.4 ai-engineer
- 集成C语言后端和Web前端
- 实现HTTP服务器和API
- 处理跨语言通信

### 7.5 frontend-developer
- 开发Chart.js可视化界面
- 设计用户交互体验
- 优化前端性能

### 7.6 code-reviewer
- 代码质量审查
- 性能优化建议
- 安全性检查

## 8. 质量保证

### 8.1 测试策略
- **单元测试**: 每个模块都有对应的测试
- **集成测试**: 测试模块间的交互
- **系统测试**: 端到端功能测试
- **性能测试**: 确保满足性能要求

### 8.2 代码质量
- **静态分析**: 使用clang-static-analyzer
- **动态分析**: 使用valgrind检查内存问题
- **代码审查**: 每个PR都经过code-reviewer审查
- **持续集成**: 自动化测试和构建

### 8.3 文档要求
- **代码注释**: 重要的函数和数据结构要有注释
- **API文档**: 每个公共API都有文档说明
- **开发文档**: 详细的设计和实现文档
- **用户文档**: 安装和使用指南

## 9. 风险管理

### 9.1 技术风险
- **RINEX解析复杂度**: 使用分阶段实现策略
- **性能要求**: 使用性能分析和优化工具
- **内存管理**: 严格的内存管理策略

### 9.2 进度风险
- **功能复杂度**: 分阶段交付，确保基本功能优先
- **技术难点**: 预留技术攻关时间
- **集成问题**: 早期进行集成测试

### 9.3 质量风险
- **测试覆盖**: 严格执行TDD流程
- **代码质量**: 多层代码审查机制
- **文档完整性**: 文档与代码同步更新

---

**文档版本**：2.0  
**创建日期**：2024-01-01  
**最后更新**：2024-01-01  
**状态**：已确认 - C语言TDD开发版本  
**确认项**：
- [x] 编程语言：C语言 (C11/C17)
- [x] 测试框架：CuTest
- [x] 开发方法：TDD
- [x] 可视化：Chart.js
- [x] 平台：Windows
- [x] 版本管理：Git
- [x] Agent分工：subagent架构